<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SecureShare - P2P File Transfer</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #ec4899;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --dark: #1f2937;
      --light: #f8fafc;
      --gray: #64748b;
      --border: #e2e8f0;
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-alt: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--gradient);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><radialGradient id="a" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="%23ffffff" stop-opacity="0.1"/><stop offset="100%" stop-color="%23ffffff" stop-opacity="0"/></radialGradient></defs><circle cx="20" cy="20" r="2" fill="url(%23a)"/><circle cx="80" cy="20" r="3" fill="url(%23a)"/><circle cx="40" cy="40" r="1" fill="url(%23a)"/><circle cx="90" cy="60" r="2" fill="url(%23a)"/><circle cx="10" cy="80" r="1" fill="url(%23a)"/></svg>') repeat;
      animation: float 20s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }

    .container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(255, 255, 255, 0.2);
      overflow: hidden;
      width: 100%;
      max-width: 900px;
      position: relative;
      z-index: 1;
    }

    .header {
      background: var(--gradient);
      padding: 32px;
      text-align: center;
      color: white;
      position: relative;
    }

    .header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    }

    .logo {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .tagline {
      font-size: 1.1rem;
      opacity: 0.9;
      font-weight: 400;
    }

    .main-content {
      padding: 40px;
    }

    .section {
      display: none;
      animation: slideIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .section.active {
      display: block;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .role-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 32px;
    }

    .role-card {
      background: white;
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 32px 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position: relative;
      overflow: hidden;
    }

    .role-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      transition: left 0.6s;
    }

    .role-card:hover::before {
      left: 100%;
    }

    .role-card:hover {
      border-color: var(--primary);
      transform: translateY(-4px);
      box-shadow: var(--shadow);
    }

    .role-card.sender:hover {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(99, 102, 241, 0.1));
    }

    .role-card.receiver:hover {
      border-color: var(--secondary);
      background: linear-gradient(135deg, rgba(236, 72, 153, 0.05), rgba(236, 72, 153, 0.1));
    }

    .role-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      display: block;
    }

    .role-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--dark);
    }

    .role-desc {
      color: var(--gray);
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .otp-section {
      text-align: center;
      margin-bottom: 32px;
    }

    .otp-label {
      font-size: 1.1rem;
      color: var(--gray);
      margin-bottom: 16px;
    }

    .otp-display {
      background: var(--gradient);
      color: white;
      font-size: 2.5rem;
      font-weight: 700;
      letter-spacing: 8px;
      padding: 24px 32px;
      border-radius: 16px;
      margin: 16px 0;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
    }

    .otp-display::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      animation: shine 3s infinite;
    }

    @keyframes shine {
      0% { left: -100%; }
      50% { left: 100%; }
      100% { left: 100%; }
    }

    .otp-input-section {
      text-align: center;
      margin-bottom: 32px;
    }

    .otp-inputs {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin: 20px 0;
    }

    .otp-input {
      width: 56px;
      height: 64px;
      border: 2px solid var(--border);
      border-radius: 12px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
      background: white;
    }

    .otp-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
      transform: scale(1.05);
    }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 16px 32px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.6s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.secondary {
      background: var(--secondary);
    }

    .btn.secondary:hover {
      background: #db2777;
    }

    .connected-section {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 32px;
      text-align: center;
    }

    .connection-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      color: var(--success);
      font-weight: 600;
      font-size: 1.1rem;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      background: var(--success);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.1); }
    }

    .transfer-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
      margin-bottom: 32px;
    }

    .transfer-panel {
      background: white;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .panel-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chat-area {
      height: 200px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      font-family: 'Inter', monospace;
      font-size: 0.9rem;
      resize: none;
      background: #f8fafc;
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .chat-input {
      display: flex;
      gap: 12px;
    }

    .chat-input input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    .chat-input input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .file-upload {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 32px 16px;
      text-align: center;
      margin-bottom: 16px;
      transition: all 0.3s ease;
      cursor: pointer;
      background: #f8fafc;
    }

    .file-upload:hover {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.05);
    }

    .file-upload.drag-over {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
      transform: scale(1.02);
    }

    .file-icon {
      font-size: 2.5rem;
      color: var(--gray);
      margin-bottom: 12px;
    }

    .progress-container {
      margin: 16px 0;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--gradient);
      border-radius: 4px;
      transition: width 0.3s ease;
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: progress-shine 2s infinite;
    }

    @keyframes progress-shine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .progress-text {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 0.9rem;
      color: var(--gray);
    }

    .download-link {
      background: var(--success);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 16px;
      transition: all 0.3s ease;
    }

    .download-link:hover {
      background: #059669;
      transform: translateY(-2px);
    }

    .back-btn {
      background: var(--gray);
      margin-right: 16px;
    }

    .back-btn:hover {
      background: #475569;
    }

    .status-message {
      padding: 16px;
      border-radius: 12px;
      margin: 16px 0;
      font-weight: 500;
    }

    .status-success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .status-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: var(--error);
    }

    .status-info {
      background: rgba(99, 102, 241, 0.1);
      border: 1px solid rgba(99, 102, 241, 0.2);
      color: var(--primary);
    }

    @media (max-width: 768px) {
      .container {
        border-radius: 0;
        min-height: 100vh;
      }

      .header {
        padding: 24px 20px;
      }

      .main-content {
        padding: 24px 20px;
      }

      .role-selector {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .transfer-section {
        grid-template-columns: 1fr;
        gap: 24px;
      }

      .otp-display {
        font-size: 2rem;
        letter-spacing: 4px;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">🚀 SecureShare</div>
      <div class="tagline">Secure Peer-to-Peer File Transfer</div>
    </div>

    <div class="main-content">
      <!-- Role Selection -->
      <div id="roleSelect" class="section active">
        <div class="role-selector">
          <div class="role-card sender" onclick="beCreator()">
            <div class="role-icon">📤</div>
            <div class="role-title">I'm Sending</div>
            <div class="role-desc">Generate a secure code and share files with someone</div>
          </div>
          <div class="role-card receiver" onclick="beJoiner()">
            <div class="role-icon">📥</div>
            <div class="role-title">I'm Receiving</div>
            <div class="role-desc">Enter the code to receive files securely</div>
          </div>
        </div>
      </div>

      <!-- OTP Generation -->
      <div id="otpSection" class="section">
        <div class="otp-section">
          <div class="otp-label">Share this secure code with the receiver:</div>
          <div class="otp-display" id="otpCode">------</div>
          <div style="color: var(--gray); font-size: 0.9rem;">⏱️ Code expires in 10 minutes</div>
        </div>
        <div style="text-align: center;">
          <button class="btn back-btn" onclick="goBack()">← Back</button>
          <div class="status-message status-info">Waiting for receiver to connect...</div>
        </div>
      </div>

      <!-- OTP Input -->
      <div id="joinSection" class="section">
        <div class="otp-input-section">
          <div class="otp-label">Enter the 6-digit secure code:</div>
          <div class="otp-inputs">
            <input type="text" maxlength="1" class="otp-input" id="otp0" oninput="nextInput(0)">
            <input type="text" maxlength="1" class="otp-input" id="otp1" oninput="nextInput(1)">
            <input type="text" maxlength="1" class="otp-input" id="otp2" oninput="nextInput(2)">
            <input type="text" maxlength="1" class="otp-input" id="otp3" oninput="nextInput(3)">
            <input type="text" maxlength="1" class="otp-input" id="otp4" oninput="nextInput(4)">
            <input type="text" maxlength="1" class="otp-input" id="otp5" oninput="nextInput(5)">
          </div>
          <div style="text-align: center;">
            <button class="btn back-btn" onclick="goBack()">← Back</button>
            <button class="btn secondary" onclick="submitOtp()">🔗 Connect</button>
          </div>
          <div id="joinStatus"></div>
        </div>
      </div>

      <!-- Connected State -->
      <div id="connectedSection" class="section">
        <div class="connected-section">
          <div class="connection-status">
            <div class="status-dot"></div>
            <span>🔒 Securely Connected</span>
          </div>
        </div>

        <div class="transfer-section">
          <!-- Chat Panel -->
          <div class="transfer-panel">
            <div class="panel-title">💬 Chat</div>
            <textarea id="chat" class="chat-area" placeholder="Messages will appear here..." readonly></textarea>
            <div class="chat-input">
              <input id="msgBox" type="text" placeholder="Type a message..." onkeypress="handleEnter(event)">
              <button class="btn" onclick="sendMsg()">Send</button>
            </div>
          </div>

          <!-- File Transfer Panel -->
          <div class="transfer-panel">
            <div class="panel-title">📁 File Transfer</div>
            <div class="file-upload" onclick="document.getElementById('fileInput').click()" 
                 ondrop="handleDrop(event)" ondragover="handleDragOver(event)" 
                 ondragleave="handleDragLeave(event)">
              <div class="file-icon">📄</div>
              <div style="font-weight: 600; margin-bottom: 4px;">Click to select or drag files here</div>
              <div style="color: var(--gray); font-size: 0.9rem;">Supports any file type, any size</div>
            </div>
            <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect()">
            <button class="btn" onclick="sendFile()" id="sendFileBtn" style="width: 100%;" disabled>
              📤 Send File
            </button>
            
            <div id="progressContainer" class="progress-container" style="display: none;">
              <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
              </div>
              <div class="progress-text">
                <span id="progressText">Preparing...</span>
                <span id="progressPercent">0%</span>
              </div>
            </div>

            <div id="downloadLink"></div>
          </div>
        </div>

        <div style="text-align: center; margin-top: 24px;">
          <button class="btn back-btn" onclick="disconnect()">❌ Disconnect</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let ws, pc, dataChannel;
    let role;
    let receivedChunks = [];
    let fileMetadata = null;
    let selectedFile = null;
    let isTransferring = false;

    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(sectionId).classList.add('active');
    }

    function goBack() {
      showSection('roleSelect');
      if (ws) ws.close();
    }

    function beCreator() {
      role = "creator";
    //   ws = new WebSocket("ws://localhost:8000/ws/creator");
    // Detect protocol: ws:// for http, wss:// for https
    const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
    const host = window.location.host; // works both locally and on Render
    const ws = new WebSocket(`${protocol}${host}/ws/creator`);

      setupWs();
      showSection('otpSection');
    }

    function beJoiner() {
      role = "joiner";
      showSection('joinSection');
      setTimeout(() => document.getElementById('otp0').focus(), 100);
    }

    function submitOtp() {
      const otp = Array.from({length: 6}, (_, i) => 
        document.getElementById(`otp${i}`).value).join('');
      
      if (otp.length !== 6 || !/^\d{6}$/.test(otp)) {
        showStatus('Enter a valid 6-digit code', 'error', 'joinStatus');
        return;
      }

    //   ws = new WebSocket("ws://localhost:8000/ws/joiner");
    // Detect protocol: ws:// for http, wss:// for https
        const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
        const host = window.location.host; // works both locally and on Render
        const ws = new WebSocket(`${protocol}${host}/ws/joiner`);

      ws.onopen = () => {
        ws.send(JSON.stringify({ otp: otp }));
      };
      setupWs();
      showStatus('Connecting...', 'info', 'joinStatus');
    }

    function setupWs() {
      ws.onmessage = async (event) => {
        const msg = JSON.parse(event.data);

        if (msg.type === "otp") {
          document.getElementById("otpCode").innerText = msg.otp;
        } 
        else if (msg.type === "connected") {
          startWebRTC();
          showSection('connectedSection');
          showStatus('Connected! You can now chat and share files.', 'success', 'joinStatus');
        } 
        else if (msg.type === "offer") {
          await pc.setRemoteDescription(msg);
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          ws.send(JSON.stringify(answer));
        } 
        else if (msg.type === "answer") {
          await pc.setRemoteDescription(msg);
        } 
        else if (msg.type === "candidate") {
          await pc.addIceCandidate(msg.candidate);
        }
        else if (msg.type === "error") {
          showStatus(msg.message, 'error', 'joinStatus');
        }
      };

      ws.onclose = () => {
        showStatus('Connection lost', 'error', 'joinStatus');
      };

      ws.onerror = () => {
        showStatus('Connection failed. Please try again.', 'error', 'joinStatus');
      };
    }

    function startWebRTC() {
      pc = new RTCPeerConnection({
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' }
        ]
      });

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          ws.send(JSON.stringify({ type: "candidate", candidate: event.candidate }));
        }
      };

      pc.ondatachannel = (event) => {
        dataChannel = event.channel;
        setupDataChannel(dataChannel);
      };

      if (role === "creator") {
        dataChannel = pc.createDataChannel("data");
        setupDataChannel(dataChannel);
        pc.createOffer().then(offer => {
          pc.setLocalDescription(offer);
          ws.send(JSON.stringify(offer));
        });
      }
    }

    function setupDataChannel(channel) {
      channel.onopen = () => {
        console.log("Data channel open");
        addChatMessage("System", "🔒 Secure connection established!");
      };
      
      channel.onmessage = (e) => handleDataMessage(e.data);
      
      channel.onerror = (error) => {
        console.error("Data channel error:", error);
        addChatMessage("System", "❌ Connection error occurred");
      };
    }

    function handleDataMessage(data) {
      if (typeof data === "string") {
        try {
          const obj = JSON.parse(data);
          if (obj.type === "file-meta") {
            fileMetadata = obj;
            receivedChunks = [];
            showProgress(0, `Receiving ${obj.name}`);
            addChatMessage("System", `📥 Receiving file: ${obj.name} (${formatFileSize(obj.size)})`);
          } else if (obj.type === "file-complete") {
            completeFileReceive();
          } else if (obj.type === "chat") {
            addChatMessage("Peer", obj.msg);
          }
        } catch {
          addChatMessage("Peer", data);
        }
      } else {
        if (fileMetadata) {
          receivedChunks.push(data);
          const progress = (receivedChunks.length * 16 * 1024) / fileMetadata.size * 100;
          showProgress(Math.min(progress, 100), `Receiving ${fileMetadata.name}`);
        }
      }
    }

    function completeFileReceive() {
      const received = new Blob(receivedChunks);
      const url = URL.createObjectURL(received);
      document.getElementById("downloadLink").innerHTML =
        `<a href="${url}" download="${fileMetadata.name}" class="download-link">
          📥 Download ${fileMetadata.name}
        </a>`;
      
      addChatMessage("System", `✅ File received: ${fileMetadata.name}`);
      hideProgress();
      receivedChunks = [];
      fileMetadata = null;
    }

    function addChatMessage(sender, message) {
      const chat = document.getElementById("chat");
      const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      chat.value += `[${timestamp}] ${sender}: ${message}\n`;
      chat.scrollTop = chat.scrollHeight;
    }

    function sendMsg() {
      const msgBox = document.getElementById("msgBox");
      const msg = msgBox.value.trim();
      if (!msg || !dataChannel) return;

      dataChannel.send(JSON.stringify({ type: "chat", msg }));
      addChatMessage("You", msg);
      msgBox.value = "";
    }

    function handleEnter(event) {
      if (event.key === 'Enter') {
        sendMsg();
      }
    }

    function handleFileSelect() {
      const fileInput = document.getElementById('fileInput');
      if (fileInput.files.length > 0) {
        selectedFile = fileInput.files[0];
        document.getElementById('sendFileBtn').disabled = false;
        document.getElementById('sendFileBtn').innerHTML = `📤 Send ${selectedFile.name}`;
      }
    }

    function handleDrop(event) {
      event.preventDefault();
      const fileUpload = event.currentTarget;
      fileUpload.classList.remove('drag-over');
      
      const files = event.dataTransfer.files;
      if (files.length > 0) {
        selectedFile = files[0];
        document.getElementById('sendFileBtn').disabled = false;
        document.getElementById('sendFileBtn').innerHTML = `📤 Send ${selectedFile.name}`;
      }
    }

    function handleDragOver(event) {
      event.preventDefault();
      event.currentTarget.classList.add('drag-over');
    }

    function handleDragLeave(event) {
      event.preventDefault();
      event.currentTarget.classList.remove('drag-over');
    }

    function sendFile() {
      if (!selectedFile || !dataChannel || isTransferring) return;
      
      isTransferring = true;
      document.getElementById('sendFileBtn').disabled = true;
      
      // Send file metadata
      const metadata = {
        type: "file-meta",
        name: selectedFile.name,
        size: selectedFile.size
      };
      
      dataChannel.send(JSON.stringify(metadata));
      addChatMessage("You", `📤 Sending file: ${selectedFile.name} (${formatFileSize(selectedFile.size)})`);
      
      // Send file in chunks
      const chunkSize = 16 * 1024; // 16KB chunks
      let offset = 0;
      const reader = new FileReader();
      
      reader.onload = e => {
        dataChannel.send(e.target.result);
        offset += e.target.result.byteLength;
        
        const progress = (offset / selectedFile.size) * 100;
        showProgress(progress, `Sending ${selectedFile.name}`);

        if (offset < selectedFile.size) {
          readSlice(offset);
        } else {
          // File transfer complete
          dataChannel.send(JSON.stringify({ type: "file-complete" }));
          addChatMessage("System", `✅ File sent successfully: ${selectedFile.name}`);
          hideProgress();
          isTransferring = false;
          document.getElementById('sendFileBtn').innerHTML = "📤 Send File";
          document.getElementById('sendFileBtn').disabled = true;
          selectedFile = null;
        }
      };

      function readSlice(o) {
        const slice = selectedFile.slice(o, o + chunkSize);
        reader.readAsArrayBuffer(slice);
      }
      
      readSlice(0);
      showProgress(0, `Sending ${selectedFile.name}`);
    }

    function showProgress(percent, text) {
      const container = document.getElementById('progressContainer');
      const fill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const progressPercent = document.getElementById('progressPercent');
      
      container.style.display = 'block';
      fill.style.width = percent + '%';
      progressText.textContent = text;
      progressPercent.textContent = Math.round(percent) + '%';
    }

    function hideProgress() {
      const container = document.getElementById('progressContainer');
      container.style.display = 'none';
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function showStatus(message, type, elementId) {
      const element = document.getElementById(elementId);
      if (element) {
        element.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
      }
    }

    function nextInput(index) {
      const current = document.getElementById(`otp${index}`);
      if (current.value.length === 1 && index < 5) {
        document.getElementById(`otp${index + 1}`).focus();
      }
      
      // Auto-submit when all fields are filled
      const allFilled = Array.from({length: 6}, (_, i) => 
        document.getElementById(`otp${i}`).value).every(val => val.length === 1);
      
      if (allFilled) {
        setTimeout(submitOtp, 500);
      }
    }

    function disconnect() {
      if (dataChannel) {
        dataChannel.close();
      }
      if (pc) {
        pc.close();
      }
      if (ws) {
        ws.close();
      }
      
      // Reset state
      dataChannel = null;
      pc = null;
      ws = null;
      selectedFile = null;
      isTransferring = false;
      receivedChunks = [];
      fileMetadata = null;
      
      // Reset UI
      document.getElementById('chat').value = '';
      document.getElementById('msgBox').value = '';
      document.getElementById('downloadLink').innerHTML = '';
      hideProgress();
      
      showSection('roleSelect');
    }

    // Handle OTP input with backspace
    document.addEventListener('DOMContentLoaded', function() {
      for (let i = 0; i < 6; i++) {
        const input = document.getElementById(`otp${i}`);
        if (input) {
          input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && this.value === '' && i > 0) {
              document.getElementById(`otp${i-1}`).focus();
            }
          });
          
          // Only allow numbers
          input.addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
            if (this.value.length > 1) {
              this.value = this.value.slice(0, 1);
            }
          });
        }
      }
    });

    // Add some welcome messages when page loads
    window.addEventListener('load', function() {
      // Add a subtle animation to role cards
      const roleCards = document.querySelectorAll('.role-card');
      roleCards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.style.animation = 'slideIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards';
      });
    });

    // Handle connection errors gracefully
    window.addEventListener('beforeunload', function() {
      if (ws) ws.close();
      if (pc) pc.close();
    });
  </script>
</body>
</html>