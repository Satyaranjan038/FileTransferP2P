<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>SecureShare Pro - Ultra-Fast P2P File Transfer</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #ec4899;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --dark: #1f2937;
      --light: #f8fafc;
      --gray: #64748b;
      --border: #e2e8f0;
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-alt: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --glass: rgba(255, 255, 255, 0.25);
      --glass-border: rgba(255, 255, 255, 0.18);
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--gradient);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      position: relative;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><radialGradient id="a" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="%23ffffff" stop-opacity="0.1"/><stop offset="100%" stop-color="%23ffffff" stop-opacity="0"/></radialGradient></defs><circle cx="20" cy="20" r="2" fill="url(%23a)"/><circle cx="80" cy="20" r="3" fill="url(%23a)"/><circle cx="40" cy="40" r="1" fill="url(%23a)"/><circle cx="90" cy="60" r="2" fill="url(%23a)"/><circle cx="10" cy="80" r="1" fill="url(%23a)"/></svg>') repeat;
      animation: float 20s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }

    .container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 0;
      box-shadow: none;
      border: none;
      overflow-y: auto;
      width: 100%;
      height: 100vh;
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: var(--gradient);
      padding: 20px 16px;
      text-align: center;
      color: white;
      position: relative;
      flex-shrink: 0;
    }

    .header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    }

    .logo {
      font-size: 1.8rem;
      font-weight: 800;
      margin-bottom: 4px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      background: linear-gradient(135deg, #fff, #e0e7ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .tagline {
      font-size: 0.9rem;
      opacity: 0.95;
      font-weight: 500;
    }

    .main-content {
      padding: 16px;
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .section {
      display: none;
      animation: slideIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      height: 100%;
    }

    .section.active {
      display: block;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .role-selector {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 24px;
      max-width: 100%;
    }

    .role-card {
      background: white;
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 24px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      touch-action: manipulation;
    }

    .role-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
      transition: left 0.6s;
    }

    .role-card:active::before,
    .role-card:hover::before {
      left: 100%;
    }

    .role-card:active,
    .role-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 8px 24px -4px rgba(99, 102, 241, 0.3);
    }

    .role-card.sender:active,
    .role-card.sender:hover {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(99, 102, 241, 0.15));
    }

    .role-card.receiver:active,
    .role-card.receiver:hover {
      border-color: var(--secondary);
      background: linear-gradient(135deg, rgba(236, 72, 153, 0.08), rgba(236, 72, 153, 0.15));
      box-shadow: 0 8px 24px -4px rgba(236, 72, 153, 0.3);
    }

    .role-icon {
      font-size: 2.5rem;
      margin-bottom: 12px;
      display: block;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
    }

    .role-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--dark);
    }

    .role-desc {
      color: var(--gray);
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .otp-section {
      text-align: center;
      margin-bottom: 24px;
      max-width: 100%;
    }

    .otp-display {
      background: var(--gradient);
      color: white;
      font-size: 2rem;
      font-weight: 800;
      letter-spacing: 6px;
      padding: 20px 16px;
      border-radius: 16px;
      margin: 16px 0;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
      position: relative;
      overflow: hidden;
      box-shadow: 0 8px 24px -4px rgba(99, 102, 241, 0.4);
    }

    .otp-display::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shine 4s infinite;
    }

    @keyframes shine {
      0% { left: -100%; }
      50% { left: 100%; }
      100% { left: 100%; }
    }

    .otp-inputs {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 24px 0;
      flex-wrap: wrap;
    }

    .otp-input {
      width: 48px;
      height: 56px;
      border: 3px solid var(--border);
      border-radius: 12px;
      text-align: center;
      font-size: 1.4rem;
      font-weight: 700;
      transition: all 0.3s ease;
      background: white;
      color: var(--dark);
      touch-action: manipulation;
    }

    .otp-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
      transform: scale(1.05);
    }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 16px 24px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 12px -2px rgba(99, 102, 241, 0.4);
      touch-action: manipulation;
      width: 100%;
      margin: 8px 0;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.6s;
    }

    .btn:active::before,
    .btn:hover::before {
      left: 100%;
    }

    .btn:active,
    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 6px 16px -2px rgba(99, 102, 241, 0.5);
    }

    .btn.secondary {
      background: var(--secondary);
      box-shadow: 0 4px 12px -2px rgba(236, 72, 153, 0.4);
    }

    .btn.secondary:active,
    .btn.secondary:hover {
      background: #db2777;
      box-shadow: 0 6px 16px -2px rgba(236, 72, 153, 0.5);
    }

    .btn.back-btn {
      background: var(--gray);
      width: auto;
      display: inline-block;
      margin-right: 12px;
    }

    .btn.back-btn:active,
    .btn.back-btn:hover {
      background: #475569;
    }

    .btn-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn-group .btn {
      flex: 1;
      min-width: 120px;
    }

    .connected-section {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.08));
      border: 2px solid rgba(16, 185, 129, 0.25);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
      backdrop-filter: blur(10px);
    }

    .connection-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      color: var(--success);
      font-weight: 700;
      font-size: 1rem;
      flex-wrap: wrap;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      background: var(--success);
      border-radius: 50%;
      animation: pulse 2s infinite;
      box-shadow: 0 0 16px rgba(16, 185, 129, 0.6);
      flex-shrink: 0;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.2); }
    }

    .transfer-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 20px;
    }

    .transfer-panel {
      background: white;
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 12px -2px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }

    .panel-title {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chat-area {
      height: 150px;
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      font-family: 'Inter', monospace;
      font-size: 0.9rem;
      resize: none;
      background: #f8fafc;
      margin-bottom: 16px;
      line-height: 1.5;
      flex-grow: 1;
      -webkit-overflow-scrolling: touch;
    }

    .chat-input {
      display: flex;
      gap: 8px;
      align-items: stretch;
    }

    .chat-input input {
      flex: 1;
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 1rem;
      transition: border-color 0.3s;
      touch-action: manipulation;
    }

    .chat-input input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    .chat-input .btn {
      width: auto;
      margin: 0;
      padding: 14px 20px;
    }

    .file-upload {
      border: 3px dashed var(--border);
      border-radius: 16px;
      padding: 32px 16px;
      text-align: center;
      margin-bottom: 16px;
      transition: all 0.3s ease;
      cursor: pointer;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      position: relative;
      overflow: hidden;
      touch-action: manipulation;
    }

    .file-upload::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(99, 102, 241, 0.05) 50%, transparent 70%);
      transform: translateX(-100%);
      transition: transform 0.6s;
    }

    .file-upload:active::before,
    .file-upload:hover::before {
      transform: translateX(100%);
    }

    .file-upload:active,
    .file-upload:hover {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(99, 102, 241, 0.12));
      transform: scale(1.02);
      box-shadow: 0 4px 12px -2px rgba(99, 102, 241, 0.2);
    }

    .file-upload.drag-over {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(99, 102, 241, 0.2));
      transform: scale(1.05);
      box-shadow: 0 6px 16px -2px rgba(99, 102, 241, 0.3);
    }

    .file-icon {
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 12px;
      filter: drop-shadow(0 4px 8px rgba(99, 102, 241, 0.3));
    }

    .file-upload-text {
      font-weight: 700;
      margin-bottom: 6px;
      font-size: 1rem;
    }

    .file-upload-desc {
      color: var(--gray);
      font-size: 0.85rem;
      line-height: 1.4;
    }

    .file-list {
      max-height: 200px;
      overflow-y: auto;
      margin: 16px 0;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: white;
      -webkit-overflow-scrolling: touch;
    }

    .file-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      transition: background-color 0.3s;
      gap: 12px;
    }

    .file-item:last-child {
      border-bottom: none;
    }

    .file-item:active,
    .file-item:hover {
      background: rgba(99, 102, 241, 0.05);
    }

    .file-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .file-info {
      flex-grow: 1;
      min-width: 0;
    }

    .file-name {
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 2px;
      word-break: break-word;
      font-size: 0.9rem;
    }

    .file-size {
      color: var(--gray);
      font-size: 0.8rem;
    }

    .file-remove {
      color: var(--error);
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      transition: background-color 0.3s;
      flex-shrink: 0;
      touch-action: manipulation;
    }

    .file-remove:active,
    .file-remove:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    .progress-container {
      margin: 16px 0;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    .progress-fill {
      height: 100%;
      background: var(--gradient);
      border-radius: 6px;
      transition: width 0.3s ease;
      position: relative;
      box-shadow: 0 2px 6px rgba(99, 102, 241, 0.4);
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: progress-shine 2s infinite;
    }

    @keyframes progress-shine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .progress-text {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 0.9rem;
      color: var(--gray);
      font-weight: 500;
      flex-wrap: wrap;
      gap: 8px;
    }

    .speed-indicator {
      font-size: 0.8rem;
      color: var(--primary);
      font-weight: 600;
    }

    .download-section {
      background: white;
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-top: 16px;
    }

    .download-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .download-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--dark);
    }

    .download-header-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .select-all-btn {
      background: var(--success);
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      touch-action: manipulation;
    }

    .select-all-btn:active,
    .select-all-btn:hover {
      background: #059669;
      transform: translateY(-1px);
    }

    .download-grid {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .download-item {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .download-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.1), transparent);
      transition: left 0.6s;
    }

    .download-item:active::before,
    .download-item:hover::before {
      left: 100%;
    }

    .download-item:active,
    .download-item:hover {
      border-color: var(--success);
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 4px 12px -2px rgba(16, 185, 129, 0.3);
    }

    .download-item.selected {
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
    }

    .download-item-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .download-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .download-file-icon {
      font-size: 2rem;
      color: var(--success);
      margin-right: 12px;
      flex-shrink: 0;
    }

    .download-file-info {
      flex: 1;
      min-width: 0;
    }

    .download-file-name {
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 4px;
      word-break: break-word;
      font-size: 0.9rem;
    }

    .download-file-size {
      color: var(--gray);
      font-size: 0.8rem;
      margin-bottom: 12px;
    }

    .download-link {
      background: var(--success);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      width: 100%;
      touch-action: manipulation;
    }

    .download-link:active,
    .download-link:hover {
      background: #059669;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px -2px rgba(16, 185, 129, 0.4);
    }

    .bulk-download {
      position: fixed;
      bottom: 16px;
      left: 16px;
      right: 16px;
      background: var(--success);
      color: white;
      padding: 16px 24px;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 16px -2px rgba(16, 185, 129, 0.4);
      transition: all 0.3s ease;
      z-index: 1000;
      display: none;
      font-size: 1rem;
      touch-action: manipulation;
    }

    .bulk-download:active,
    .bulk-download:hover {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px -2px rgba(16, 185, 129, 0.5);
    }

    .bulk-download.show {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      animation: slideUp 0.4s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .status-message {
      padding: 16px;
      border-radius: 12px;
      margin: 16px 0;
      font-weight: 600;
      font-size: 1rem;
    }

    .status-success {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.1));
      border: 2px solid rgba(16, 185, 129, 0.25);
      color: var(--success);
    }

    .status-error {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.1));
      border: 2px solid rgba(239, 68, 68, 0.25);
      color: var(--error);
    }

    .status-info {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(99, 102, 241, 0.1));
      border: 2px solid rgba(99, 102, 241, 0.25);
      color: var(--primary);
    }

    /* Desktop Responsive Adjustments */
    @media (min-width: 768px) {
      body {
        padding: 20px;
      }

      .container {
        border-radius: 24px;
        box-shadow: var(--shadow-lg);
        border: 1px solid rgba(255, 255, 255, 0.2);
        max-width: 1200px;
        min-height: 80vh;
        height: auto;
      }

      .header {
        padding: 32px;
      }

      .logo {
        font-size: 2.8rem;
      }

      .tagline {
        font-size: 1.2rem;
      }

      .main-content {
        padding: 40px;
        height: auto;
      }

      .role-selector {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 32px;
        max-width: 800px;
        margin: 0 auto 32px;
      }

      .role-card {
        padding: 40px 32px;
        transform: perspective(1000px) rotateX(0deg);
      }

      .role-card:hover {
        transform: perspective(1000px) rotateX(5deg) translateY(-8px) scale(1.02);
        box-shadow: 0 20px 40px -10px rgba(99, 102, 241, 0.3);
      }

      .role-icon {
        font-size: 4rem;
        margin-bottom: 20px;
      }

      .role-title {
        font-size: 1.4rem;
        margin-bottom: 12px;
      }

      .role-desc {
        font-size: 1rem;
      }

      .otp-display {
        font-size: 3.5rem;
        letter-spacing: 12px;
        padding: 32px 48px;
        margin: 24px 0;
      }

      .otp-inputs {
        gap: 16px;
      }

      .otp-input {
        width: 64px;
        height: 72px;
        font-size: 1.8rem;
      }

      .btn {
        width: auto;
        display: inline-block;
        margin: 8px 4px;
        padding: 18px 36px;
      }

      .btn-group {
        justify-content: center;
      }

      .transfer-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 32px;
        height: auto;
      }

      .transfer-panel {
        padding: 32px;
      }

      .panel-title {
        font-size: 1.4rem;
        margin-bottom: 24px;
        gap: 12px;
      }

      .chat-area {
        height: 200px;
        padding: 20px;
        font-size: 0.95rem;
        margin-bottom: 20px;
      }

      .chat-input input {
        padding: 16px 20px;
      }

      .file-upload {
        padding: 48px 24px;
        margin-bottom: 24px;
      }

      .file-icon {
        font-size: 3.5rem;
        margin-bottom: 20px;
      }

      .file-upload-text {
        font-size: 1.1rem;
        margin-bottom: 8px;
      }

      .file-upload-desc {
        font-size: 0.95rem;
      }

      .file-list {
        max-height: 300px;
        margin: 20px 0;
      }

      .file-item {
        padding: 16px 20px;
      }

      .file-name {
        font-size: 1rem;
        margin-bottom: 4px;
      }

      .file-size {
        font-size: 0.9rem;
      }

      .progress-text {
        font-size: 1rem;
        margin-top: 12px;
      }

      .speed-indicator {
        font-size: 0.9rem;
      }

      .download-section {
        padding: 32px;
        margin-top: 24px;
      }

      .download-header {
        margin-bottom: 24px;
      }

      .download-title {
        font-size: 1.4rem;
      }

      .download-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
      }

      .download-item {
        padding: 24px;
      }

      .download-file-icon {
        font-size: 2.5rem;
        margin-bottom: 16px;
      }

      .download-file-name {
        font-size: 1rem;
        margin-bottom: 8px;
      }

      .download-file-size {
        font-size: 0.9rem;
        margin-bottom: 16px;
      }

      .download-link {
        font-size: 1rem;
        padding: 12px 20px;
        gap: 8px;
      }

      .bulk-download {
        position: fixed;
        bottom: 32px;
        right: 32px;
        left: auto;
        width: auto;
        border-radius: 50px;
        padding: 16px 32px;
      }
    }

    /* Large Desktop */
    @media (min-width: 1024px) {
      .download-grid {
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      }
    }

    /* Performance optimizations */
    .section {
      will-change: transform, opacity;
    }

    .role-card {
      will-change: transform;
    }

    .btn {
      will-change: transform;
    }

    .progress-fill {
      will-change: width;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    /* Touch-friendly adjustments */
    @media (pointer: coarse) {
      .btn {
        min-height: 48px;
      }
      
      .file-checkbox,
      .download-checkbox {
        min-width: 24px;
        min-height: 24px;
      }
      
      .file-remove {
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">üöÄ SecureShare Pro</div>
      <div class="tagline">Ultra-Fast Peer-to-Peer File Transfer ‚Ä¢ Small File</div>
    </div>

    <div class="main-content">
      <!-- Role Selection -->
      <div id="roleSelect" class="section active">
        <div class="role-selector">
          <div class="role-card sender" onclick="beCreator()">
            <div class="role-icon">üì§</div>
            <div class="role-title">I'm Sending</div>
            <div class="role-desc">Generate a secure code and share multiple files up to 5GB each</div>
          </div>
          <div class="role-card receiver" onclick="beJoiner()">
            <div class="role-icon">üì•</div>
            <div class="role-title">I'm Receiving</div>
            <div class="role-desc">Enter the code to receive files with ultra-fast transfer speeds</div>
          </div>
        </div>
      </div>

      <!-- OTP Generation -->
      <div id="otpSection" class="section">
        <div class="otp-section">
          <div class="otp-label">Share this secure code with the receiver:</div>
          <div class="otp-display" id="otpCode">------</div>
          <div style="color: var(--gray); font-size: 0.9rem; font-weight: 500; text-align: center;">‚è±Ô∏è Code expires in 10 minutes ‚Ä¢ üîí End-to-end encrypted</div>
        </div>
        <div style="text-align: center;">
          <button class="btn back-btn" onclick="goBack()">‚Üê Back</button>
          <div class="status-message status-info">üîÑ Waiting for receiver to connect...</div>
        </div>
      </div>

      <!-- OTP Input -->
      <div id="joinSection" class="section">
        <div class="otp-input-section">
          <div class="otp-label" style="text-align: center; margin-bottom: 16px; font-weight: 600;">Enter the 6-digit secure code:</div>
          <div class="otp-inputs">
            <input type="text" maxlength="1" class="otp-input" id="otp0" oninput="nextInput(0)">
            <input type="text" maxlength="1" class="otp-input" id="otp1" oninput="nextInput(1)">
            <input type="text" maxlength="1" class="otp-input" id="otp2" oninput="nextInput(2)">
            <input type="text" maxlength="1" class="otp-input" id="otp3" oninput="nextInput(3)">
            <input type="text" maxlength="1" class="otp-input" id="otp4" oninput="nextInput(4)">
            <input type="text" maxlength="1" class="otp-input" id="otp5" oninput="nextInput(5)">
          </div>
          <div style="text-align: center;">
            <div class="btn-group">
              <button class="btn back-btn" onclick="goBack()">‚Üê Back</button>
              <button class="btn secondary" onclick="submitOtp()">üîó Connect Securely</button>
            </div>
          </div>
          <div id="joinStatus"></div>
        </div>
      </div>

      <!-- Connected State -->
      <div id="connectedSection" class="section">
        <div class="connected-section">
          <div class="connection-status">
            <div class="status-dot"></div>
            <span>üîí Securely Connected ‚Ä¢ Ultra-Fast Mode Active</span>
          </div>
        </div>

        <div class="transfer-section">
          <!-- Chat Panel -->
          <div class="transfer-panel">
            <div class="panel-title">üí¨ Secure Chat</div>
            <textarea id="chat" class="chat-area" placeholder="Messages will appear here..." readonly></textarea>
            <div class="chat-input">
              <input id="msgBox" type="text" placeholder="Type a message..." onkeypress="handleEnter(event)">
              <button class="btn" onclick="sendMsg()">Send</button>
            </div>
          </div>

          <!-- Enhanced File Transfer Panel -->
          <div class="transfer-panel">
            <div class="panel-title">üìÅ Multi-File Transfer (Up to 5GB each)</div>
            <div class="file-upload" onclick="document.getElementById('fileInput').click()" 
                 ondrop="handleDrop(event)" ondragover="handleDragOver(event)" 
                 ondragleave="handleDragLeave(event)">
              <div class="file-icon">üìÑ</div>
              <div class="file-upload-text">Click to select or drag multiple files here</div>
              <div class="file-upload-desc">
                ‚ú® Multi-select supported<br>
                üöÄ Ultra-fast transfer up to 5GB per file<br>
                üì± Any file type supported
              </div>
            </div>
            <!-- <input type="file" id="fileInput" style="display: none;" multiple onchange="handleFileSelect()"> -->
             <input type="file" id="fileInput" style="display:none;" 
       multiple accept="*/*" capture="filesystem" onchange="handleFileSelect()">

            
            <div id="fileList" class="file-list" style="display: none;"></div>
            
            <div class="btn-group">
              <button class="btn" onclick="selectAllFiles()" id="selectAllBtn" disabled>
                ‚úÖ Select All
              </button>
              <button class="btn secondary" onclick="clearFiles()" id="clearFilesBtn" disabled>
                üóëÔ∏è Clear All
              </button>
            </div>
            
            <button class="btn" onclick="sendFiles()" id="sendFileBtn" style="width: 100%;" disabled>
              üì§ Send Selected Files
            </button>
            
            <div id="progressContainer" class="progress-container" style="display: none;">
              <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
              </div>
              <div class="progress-text">
                <span id="progressText">Preparing...</span>
                <div>
                  <span id="progressPercent">0%</span>
                  <span id="transferSpeed" class="speed-indicator"></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Enhanced Download Section -->
        <div id="downloadSection" class="download-section" style="display: none;">
          <div class="download-header">
            <div class="download-title">üì• Received Files</div>
            <div class="download-header-actions">
              <button class="select-all-btn" onclick="selectAllDownloads()">
                ‚úÖ Select All Downloads
              </button>
              <button class="btn secondary" onclick="clearAll()" id="clearAllBtn" style="padding: 8px 16px; font-size: 0.9rem;">
                üóëÔ∏è Clear All
              </button>
            </div>
          </div>
          <div id="downloadGrid" class="download-grid"></div>
        </div>

        <div style="text-align: center; margin-top: 24px;">
          <button class="btn back-btn" onclick="disconnect()">‚ùå Disconnect</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Download Button -->
  <button id="bulkDownloadBtn" class="bulk-download" onclick="downloadSelected()">
    <span>üì•</span>
    <span id="bulkDownloadText">Download Selected (0)</span>
  </button>

  <script>
    // Enhanced P2P file transfer with mobile optimizations
    let ws, pc, dataChannel;
    let role;
    let receivedChunks = [];
    let fileMetadata = null;
    let selectedFiles = [];
    let isTransferring = false;
    let transferStartTime = 0;
    let totalBytesTransferred = 0;
    let receivedFiles = [];
    let selectedDownloads = new Set();

    // Mobile-optimized tunables
    const CHUNK_SIZE = 32 * 1024; // Reduced for mobile
    const MAX_FILE_SIZE = 5 * 1024 * 1024 * 1024;
    const MAX_FILE_COUNT = 50; // Reduced for mobile memory
    const MAX_SCTP_BUFFERED = 8 * 1024 * 1024; // Reduced for mobile
    const BUFFERED_LOW_THRESHOLD = 4 * 1024 * 1024;

    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
      const el = document.getElementById(sectionId);
      if (el) el.classList.add('active');
    }

    function goBack() {
      showSection('roleSelect');
      if (ws) ws.close();
      resetState();
    }

    function resetState() {
      selectedFiles = [];
      selectedDownloads.clear();
      updateFileList();
      updateDownloadSection();
      updateBulkDownloadButton();
      hideProgress();
    }

    function beCreator() {
      role = 'creator';
      ws = new WebSocket('wss://filetransferp2p.onrender.com/ws/creator');
      setupWs();
      showSection('otpSection');
    }

    function beJoiner() {
      role = 'joiner';
      showSection('joinSection');
      setTimeout(() => document.getElementById('otp0')?.focus(), 100);
    }

    function submitOtp() {
      const otp = Array.from({ length: 6 }, (_, i) => document.getElementById(`otp${i}`).value).join('');
      if (otp.length !== 6 || !/^\d{6}$/.test(otp)) {
        showStatus('‚ö†Ô∏è Enter a valid 6-digit code', 'error', 'joinStatus');
        return;
      }
      ws = new WebSocket('wss://filetransferp2p.onrender.com/ws/joiner');
      ws.onopen = () => ws.send(JSON.stringify({ otp }));
      setupWs();
      showStatus('üîÑ Connecting securely...', 'info', 'joinStatus');
    }

    function setupWs() {
      ws.onmessage = async (event) => {
        try {
          const msg = JSON.parse(event.data);
          if (msg.type === 'otp') {
            document.getElementById('otpCode').innerText = msg.otp;
          } else if (msg.type === 'connected') {
            startWebRTC();
            showSection('connectedSection');
            showStatus('‚úÖ Connected! Ultra-fast transfer mode active.', 'success', 'joinStatus');
          } else if (msg.type === 'offer') {
            await pc.setRemoteDescription(msg);
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify(answer));
          } else if (msg.type === 'answer') {
            await pc.setRemoteDescription(msg);
          } else if (msg.type === 'candidate') {
            await pc.addIceCandidate(msg.candidate);
          } else if (msg.type === 'error') {
            showStatus(`‚ùå ${msg.message}`, 'error', 'joinStatus');
          }
        } catch (err) {
          console.error('ws message parse error', err);
        }
      };
      ws.onclose = () => showStatus('üîå Connection lost', 'error', 'joinStatus');
      ws.onerror = () => showStatus('‚ùå Connection failed. Please try again.', 'error', 'joinStatus');
    }

    function startWebRTC() {
      pc = new RTCPeerConnection({
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' },
          { urls: 'stun:stun2.l.google.com:19302' }
        ]
      });

      pc.onicecandidate = (event) => {
        if (event.candidate && ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'candidate', candidate: event.candidate }));
        }
      };

      pc.ondatachannel = (event) => {
        dataChannel = event.channel;
        setupDataChannel(dataChannel);
      };

      if (role === 'creator') {
        dataChannel = pc.createDataChannel('data', {
          ordered: true,
        });
        setupDataChannel(dataChannel);
        pc.createOffer().then(offer => {
          pc.setLocalDescription(offer);
          if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(offer));
        });
      }
    }

    function setupDataChannel(channel) {
      channel.binaryType = 'arraybuffer';
      try {
        channel.bufferedAmountLowThreshold = BUFFERED_LOW_THRESHOLD;
      } catch (e) {
        // Ignore if not supported
      }

      channel.onopen = () => {
        console.log('Data channel open');
        addChatMessage('System', 'üîí Ultra-fast secure connection established!');
        updateFileList();
      };

      channel.onmessage = async (e) => {
        await handleDataMessage(e.data);
      };

      channel.onerror = (error) => {
        console.error('Data channel error:', error);
        addChatMessage('System', '‚ùå Connection error occurred');
      };
    }

    async function handleDataMessage(data) {
      if (typeof data === 'string') {
        try {
          const obj = JSON.parse(data);
          if (obj.type === 'file-meta') {
            fileMetadata = obj;
            receivedChunks = [];
            transferStartTime = Date.now();
            totalBytesTransferred = 0;
            showProgress(0, `Receiving ${obj.name}`, 0);
            addChatMessage('System', `üì• Receiving: ${obj.name} (${formatFileSize(obj.size)})`);
          } else if (obj.type === 'file-complete') {
            completeFileReceive();
          } else if (obj.type === 'chat') {
            addChatMessage('Peer', obj.msg);
          }
        } catch (err) {
          addChatMessage('Peer', data);
        }
      } else {
        if (fileMetadata) {
          receivedChunks.push(data);
          const chunkLength = (data instanceof ArrayBuffer) ? data.byteLength : (data.size || 0);
          totalBytesTransferred += chunkLength;

          const progress = (totalBytesTransferred / fileMetadata.size) * 100;
          const elapsed = Math.max((Date.now() - transferStartTime) / 1000, 0.001);
          const speed = totalBytesTransferred / elapsed;
          showProgress(Math.min(progress, 100), `Receiving ${fileMetadata.name}`, speed);
        } else {
          console.warn('Received binary data but no file metadata present');
        }
      }
    }

    function completeFileReceive() {
      try {
        const received = new Blob(receivedChunks);
        const url = URL.createObjectURL(received);
        const fileInfo = {
          name: fileMetadata.name,
          size: fileMetadata.size,
          url: url,
          id: `${Date.now()}-${Math.random().toString(36).slice(2,9)}`
        };
        receivedFiles.push(fileInfo);
        updateDownloadSection();
        addChatMessage('System', `‚úÖ File received: ${fileMetadata.name}`);
      } catch (err) {
        console.error('Error assembling received file', err);
        addChatMessage('System', '‚ùå Error assembling received file');
      } finally {
        hideProgress();
        receivedChunks = [];
        fileMetadata = null;
        totalBytesTransferred = 0;
      }
    }

    function updateDownloadSection() {
      const downloadSection = document.getElementById('downloadSection');
      const downloadGrid = document.getElementById('downloadGrid');
      if (!downloadSection || !downloadGrid) return;

      if (receivedFiles.length === 0) {
        downloadSection.style.display = 'none';
        return;
      }

      downloadSection.style.display = 'block';
      downloadGrid.innerHTML = '';

      receivedFiles.forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = `download-item ${selectedDownloads.has(file.id) ? 'selected' : ''}`;

        fileItem.innerHTML = `
          <div class="download-item-header">
            <div style="display: flex; align-items: center;">
              <div class="download-file-icon">${getFileIcon(file.name)}</div>
              <div class="download-file-info">
                <div class="download-file-name">${file.name}</div>
                <div class="download-file-size">${formatFileSize(file.size)}</div>
              </div>
            </div>
            <input type="checkbox" class="download-checkbox" data-file-id="${file.id}" ${selectedDownloads.has(file.id) ? 'checked' : ''}>
          </div>
          <a href="${file.url}" download="${file.name}" class="download-link">üì• Download</a>
        `;

        downloadGrid.appendChild(fileItem);
      });

      downloadGrid.querySelectorAll('.download-checkbox').forEach(cb => {
        cb.removeEventListener('change', onDownloadCheckboxChange);
        cb.addEventListener('change', onDownloadCheckboxChange);
      });

      updateBulkDownloadButton();
    }

    function onDownloadCheckboxChange(e) {
      const id = e.target.getAttribute('data-file-id');
      if (!id) return;
      if (e.target.checked) selectedDownloads.add(id);
      else selectedDownloads.delete(id);
      updateDownloadSection();
    }

    function selectAllDownloads() {
      receivedFiles.forEach(file => selectedDownloads.add(file.id));
      updateDownloadSection();
    }

    function updateBulkDownloadButton() {
      const bulkBtn = document.getElementById('bulkDownloadBtn');
      const bulkText = document.getElementById('bulkDownloadText');
      if (!bulkBtn) return;
      if (selectedDownloads.size > 0) {
        bulkBtn.classList.add('show');
        if (bulkText) bulkText.textContent = `Download Selected (${selectedDownloads.size})`;
      } else {
        bulkBtn.classList.remove('show');
      }
    }

    function downloadSelected() {
      receivedFiles
        .filter(file => selectedDownloads.has(file.id))
        .forEach(file => {
          const link = document.createElement('a');
          link.href = file.url;
          link.download = file.name;
          document.body.appendChild(link);
          link.click();
          link.remove();
        });
    }

    function clearAll() {
      selectedFiles = [];
      selectedDownloads.clear();
      receivedFiles.forEach(f => { try { URL.revokeObjectURL(f.url); } catch (e) {} });
      receivedFiles = [];
      updateFileList();
      updateDownloadSection();
      updateBulkDownloadButton();
      addChatMessage('System', 'üßπ Cleared all files. You can now select new files.');
    }

    function getFileIcon(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const icons = {
        pdf: 'üìÑ', doc: 'üìù', docx: 'üìù', txt: 'üìù',
        jpg: 'üñºÔ∏è', jpeg: 'üñºÔ∏è', png: 'üñºÔ∏è', gif: 'üñºÔ∏è', svg: 'üñºÔ∏è',
        mp4: 'üé•', avi: 'üé•', mov: 'üé•', wmv: 'üé•',
        mp3: 'üéµ', wav: 'üéµ', flac: 'üéµ', m4a: 'üéµ',
        zip: 'üóúÔ∏è', rar: 'üóúÔ∏è', '7z': 'üóúÔ∏è',
        exe: '‚öôÔ∏è', msi: '‚öôÔ∏è',
        html: 'üåê', css: 'üé®', js: '‚ö°', json: 'üìã'
      };
      return icons[ext] || 'üìÑ';
    }

    function addChatMessage(sender, message) {
      const chat = document.getElementById('chat');
      if (!chat) return;
      const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      chat.value += `[${timestamp}] ${sender}: ${message}\n`;
      chat.scrollTop = chat.scrollHeight;
    }

    function sendMsg() {
      const msgBox = document.getElementById('msgBox');
      const msg = msgBox?.value?.trim();
      if (!msg || !dataChannel || dataChannel.readyState !== 'open') return;
      dataChannel.send(JSON.stringify({ type: 'chat', msg }));
      addChatMessage('You', msg);
      if (msgBox) msgBox.value = '';
    }

    function handleEnter(event) {
      if (event.key === 'Enter') sendMsg();
    }

    function handleFileSelect() {
      const fileInput = document.getElementById('fileInput');
      if (!fileInput) return;
      const newFiles = Array.from(fileInput.files || []);

      const allowed = Math.max(0, MAX_FILE_COUNT - selectedFiles.length);
      if (newFiles.length > allowed) {
        addChatMessage('System', `‚ö†Ô∏è You can add only ${allowed} more files (limit ${MAX_FILE_COUNT}).`);
      }

      const filesToAdd = newFiles.slice(0, allowed);
      filesToAdd.forEach(file => {
        if (file.size > MAX_FILE_SIZE) {
          addChatMessage('System', `‚ùå File too large: ${file.name} (max ${formatFileSize(MAX_FILE_SIZE)})`);
          return;
        }
        const exists = selectedFiles.some(f => f.file.name === file.name && f.file.size === file.size);
        if (!exists) {
          selectedFiles.push({ file, selected: true, id: `${Date.now()}-${Math.random().toString(36).slice(2,9)}` });
        }
      });
      updateFileList();
    }

    function handleDrop(event) {
      event.preventDefault();
      const fileUpload = event.currentTarget;
      fileUpload?.classList?.remove('drag-over');
      const newFiles = Array.from(event.dataTransfer.files || []);

      const allowed = Math.max(0, MAX_FILE_COUNT - selectedFiles.length);
      if (newFiles.length > allowed) addChatMessage('System', `‚ö†Ô∏è You can add only ${allowed} more files (limit ${MAX_FILE_COUNT}).`);

      newFiles.slice(0, allowed).forEach(file => {
        if (file.size > MAX_FILE_SIZE) {
          addChatMessage('System', `‚ùå File too large: ${file.name} (max ${formatFileSize(MAX_FILE_SIZE)})`);
          return;
        }
        const exists = selectedFiles.some(f => f.file.name === file.name && f.file.size === file.size);
        if (!exists) selectedFiles.push({ file, selected: true, id: `${Date.now()}-${Math.random().toString(36).slice(2,9)}` });
      });
      updateFileList();
    }

    function handleDragOver(event) { event.preventDefault(); event.currentTarget?.classList?.add('drag-over'); }
    function handleDragLeave(event) { event.preventDefault(); event.currentTarget?.classList?.remove('drag-over'); }

    function updateFileList() {
      const fileList = document.getElementById('fileList');
      const sendBtn = document.getElementById('sendFileBtn');
      const selectAllBtn = document.getElementById('selectAllBtn');
      const clearBtn = document.getElementById('clearFilesBtn');
      const clearAllBtn = document.getElementById('clearAllBtn');
      if (!fileList) return;

      if (selectedFiles.length === 0) {
        fileList.style.display = 'none';
        if (sendBtn) { sendBtn.disabled = true; sendBtn.innerHTML = 'üì§ Send Selected Files'; }
        if (selectAllBtn) selectAllBtn.disabled = true;
        if (clearBtn) clearBtn.disabled = true;
        return;
      }

      fileList.style.display = 'block';
      if (selectAllBtn) selectAllBtn.disabled = false;
      if (clearBtn) clearBtn.disabled = false;
      if (clearAllBtn) clearAllBtn.disabled = false;

      fileList.innerHTML = '';
      selectedFiles.forEach((entry, index) => {
        const file = entry.file;
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
          <input type="checkbox" class="file-checkbox" data-file-idx="${index}" ${entry.selected ? 'checked' : ''}>
          <div class="file-info">
            <div class="file-name">${getFileIcon(file.name)} ${file.name}</div>
            <div class="file-size">${formatFileSize(file.size)}</div>
          </div>
          <div class="file-remove" data-remove-idx="${index}">üóëÔ∏è</div>
        `;
        fileList.appendChild(fileItem);
      });

      fileList.querySelectorAll('.file-checkbox').forEach(cb => {
        cb.removeEventListener('change', onFileCheckboxChange);
        cb.addEventListener('change', onFileCheckboxChange);
      });
      fileList.querySelectorAll('.file-remove').forEach(btn => {
        btn.removeEventListener('click', onFileRemoveClick);
        btn.addEventListener('click', onFileRemoveClick);
      });

      const selectedCount = selectedFiles.filter(f => f.selected).length;
      const totalSize = selectedFiles.filter(f => f.selected).reduce((s, f) => s + f.file.size, 0);
      if (sendBtn) {
        sendBtn.disabled = selectedCount === 0 || !dataChannel || dataChannel.readyState !== 'open' || isTransferring;
        sendBtn.innerHTML = selectedCount > 0 ? `üì§ Send ${selectedCount} Files (${formatFileSize(totalSize)})` : 'üì§ Send Selected Files';
      }
    }

    function onFileCheckboxChange(e) {
      const idx = parseInt(e.target.getAttribute('data-file-idx'), 10);
      if (Number.isFinite(idx) && selectedFiles[idx]) selectedFiles[idx].selected = e.target.checked;
      updateFileList();
    }

    function onFileRemoveClick(e) {
      const idx = parseInt(e.target.getAttribute('data-remove-idx'), 10);
      if (Number.isFinite(idx)) {
        selectedFiles.splice(idx, 1);
        updateFileList();
      }
    }

    function selectAllFiles() {
      selectedFiles.forEach(file => file.selected = true);
      updateFileList();
    }

    function clearFiles() {
      selectedFiles = [];
      updateFileList();
    }

    async function sendFiles() {
      const filesToSend = selectedFiles.filter(f => f.selected);
      if (filesToSend.length === 0 || !dataChannel || dataChannel.readyState !== 'open' || isTransferring) return;
      isTransferring = true;
      document.getElementById('sendFileBtn').disabled = true;
      try {
        for (let i = 0; i < filesToSend.length; i++) {
          await sendSingleFile(filesToSend[i].file);
          await sleep(150);
        }
        addChatMessage('System', `‚úÖ All files sent successfully! (${filesToSend.length} files)`);
        selectedFiles = selectedFiles.filter(f => !f.selected);
        updateFileList();
      } catch (err) {
        console.error('Error while sending files', err);
        addChatMessage('System', '‚ùå Error while sending files');
      } finally {
        isTransferring = false;
        document.getElementById('sendFileBtn').disabled = false;
        hideProgress();
      }
    }

    async function sendSingleFile(file) {
      if (!dataChannel || dataChannel.readyState !== 'open') throw new Error('DataChannel not open');
      const metadata = { type: 'file-meta', name: file.name, size: file.size };
      dataChannel.send(JSON.stringify(metadata));
      addChatMessage('You', `üì§ Sending: ${file.name} (${formatFileSize(file.size)})`);

      transferStartTime = Date.now();
      totalBytesTransferred = 0;

      let offset = 0;
      showProgress(0, `Sending ${file.name}`, 0);

      while (offset < file.size) {
        const chunkEnd = Math.min(offset + CHUNK_SIZE, file.size);
        const chunk = await file.slice(offset, chunkEnd).arrayBuffer();

        await waitForBufferBelow(MAX_SCTP_BUFFERED);

        try {
          dataChannel.send(chunk);
        } catch (err) {
          console.error('send error', err);
          throw err;
        }

        offset = chunkEnd;
        totalBytesTransferred += chunk.byteLength;

        const progress = (offset / file.size) * 100;
        const elapsed = Math.max((Date.now() - transferStartTime) / 1000, 0.001);
        const speed = totalBytesTransferred / elapsed;
        showProgress(progress, `Sending ${file.name}`, speed);
      }

      dataChannel.send(JSON.stringify({ type: 'file-complete' }));
      addChatMessage('System', `‚úÖ Sent: ${file.name}`);
    }

    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

    function waitForBufferBelow(threshold) {
      return new Promise((resolve) => {
        if (!dataChannel) return resolve();
        if (dataChannel.bufferedAmount <= threshold) return resolve();

        let resolved = false;
        const onLow = () => {
          if (resolved) return;
          if (dataChannel.bufferedAmount <= threshold) {
            resolved = true;
            cleanup();
            resolve();
          }
        };
        const cleanup = () => {
          try { dataChannel.removeEventListener('bufferedamountlow', onLow); } catch (e) {}
          if (pollId) clearInterval(pollId);
        };

        try {
          dataChannel.addEventListener('bufferedamountlow', onLow);
        } catch (e) {
          // ignore
        }

        const pollId = setInterval(() => {
          if (!dataChannel) { clearInterval(pollId); resolve(); return; }
          if (dataChannel.bufferedAmount <= threshold) {
            resolved = true;
            cleanup();
            resolve();
          }
        }, 100);
      });
    }

    function showProgress(percent, text, speed = 0) {
      const container = document.getElementById('progressContainer');
      const fill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const progressPercent = document.getElementById('progressPercent');
      const transferSpeed = document.getElementById('transferSpeed');
      if (!container) return;
      container.style.display = 'block';
      if (fill) fill.style.width = percent + '%';
      if (progressText) progressText.textContent = text;
      if (progressPercent) progressPercent.textContent = Math.round(percent) + '%';
      if (transferSpeed) transferSpeed.textContent = speed > 0 ? ` ‚Ä¢ ${formatSpeed(speed)}` : '';
    }

    function hideProgress() {
      const container = document.getElementById('progressContainer');
      if (container) container.style.display = 'none';
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatSpeed(bytesPerSecond) {
      if (bytesPerSecond === 0) return '0 B/s';
      const k = 1024;
      const sizes = ['B/s', 'KB/s', 'MB/s', 'GB/s'];
      const i = Math.floor(Math.log(bytesPerSecond) / Math.log(k));
      return parseFloat((bytesPerSecond / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function showStatus(message, type, elementId) {
      const element = document.getElementById(elementId);
      if (!element) return;
      element.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
    }

    function nextInput(index) {
      const current = document.getElementById(`otp${index}`);
      if (current && current.value.length === 1 && index < 5) document.getElementById(`otp${index + 1}`)?.focus();
      const allFilled = Array.from({ length: 6 }, (_, i) => document.getElementById(`otp${i}`)?.value).every(val => val && val.length === 1);
      if (allFilled) setTimeout(submitOtp, 500);
    }

    function disconnect() {
      if (dataChannel) try { dataChannel.close(); } catch (e) {}
      if (pc) try { pc.close(); } catch (e) {}
      if (ws) try { ws.close(); } catch (e) {}
      resetState();
      const chatEl = document.getElementById('chat'); if (chatEl) chatEl.value = '';
      const msgBox = document.getElementById('msgBox'); if (msgBox) msgBox.value = '';
      hideProgress();
      showSection('roleSelect');
    }

    // Enhanced mobile event handling
    document.addEventListener('DOMContentLoaded', function() {
      // Enhanced OTP input handling
      for (let i = 0; i < 6; i++) {
        const input = document.getElementById(`otp${i}`);
        if (!input) continue;
        
        // Prevent zoom on iOS
        input.addEventListener('focus', function() {
          this.style.fontSize = '16px';
        });
        
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Backspace' && this.value === '' && i > 0) {
            document.getElementById(`otp${i - 1}`)?.focus();
          }
        });
        
        input.addEventListener('input', function() {
          this.value = this.value.replace(/[^0-9]/g, '');
          if (this.value.length > 1) this.value = this.value.slice(0, 1);
        });
        
        input.addEventListener('paste', function(e) {
          e.preventDefault();
          const paste = (e.clipboardData || window.clipboardData).getData('text');
          const digits = paste.replace(/[^0-9]/g, '').slice(0, 6);
          for (let j = 0; j < digits.length && (i + j) < 6; j++) {
            document.getElementById(`otp${i + j}`).value = digits[j];
          }
          if (digits.length === 6) setTimeout(submitOtp, 300);
        });
      }

      // Prevent double-tap zoom on buttons
      document.querySelectorAll('.btn, .role-card').forEach(el => {
        el.addEventListener('touchstart', function() {});
      });

      // Enhanced file input for mobile
      const fileInput = document.getElementById('fileInput');
      if (fileInput) {
        fileInput.setAttribute('accept', '*/*');
        fileInput.setAttribute('capture', 'environment');
      }

      resetState();
    });

    // Mobile-optimized touch handling
    let touchStartY = 0;
    document.addEventListener('touchstart', function(e) {
      touchStartY = e.touches[0].clientY;
    }, { passive: true });

    document.addEventListener('touchmove', function(e) {
      const touchY = e.touches[0].clientY;
      const touchDiff = touchStartY - touchY;
      
      // Prevent bounce scrolling at top/bottom
      const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
      const scrollHeight = document.documentElement.scrollHeight;
      const clientHeight = document.documentElement.clientHeight;
      
      if ((scrollTop === 0 && touchDiff < 0) || 
          (scrollTop + clientHeight >= scrollHeight && touchDiff > 0)) {
        e.preventDefault();
      }
    }, { passive: false });

    // Graceful cleanup
    window.addEventListener('beforeunload', function() {
      if (ws) ws.close();
      if (pc) pc.close();
      receivedFiles.forEach(f => { try { URL.revokeObjectURL(f.url); } catch (e) {} });
    });

    // Prevent accidental refresh on mobile
    window.addEventListener('beforeunload', function(e) {
      if (isTransferring || (selectedFiles.length > 0 && selectedFiles.some(f => f.selected)) || receivedFiles.length > 0) {
        e.preventDefault();
        e.returnValue = '';
        return '';
      }
    });

    // Handle orientation change
    window.addEventListener('orientationchange', function() {
      setTimeout(() => {
        window.scrollTo(0, 0);
      }, 100);
    });

    // Network status monitoring
    window.addEventListener('online', function() {
      addChatMessage('System', 'üåê Connection restored');
    });

    window.addEventListener('offline', function() {
      addChatMessage('System', 'üì° Connection lost - transfers may be interrupted');
    });

    // Performance monitoring
    if ('memory' in performance) {
      setInterval(() => {
        const memory = performance.memory;
        if (memory.usedJSHeapSize / memory.jsHeapSizeLimit > 0.9) {
          console.warn('High memory usage detected');
          addChatMessage('System', '‚ö†Ô∏è High memory usage - consider clearing files');
        }
      }, 30000);
    }
  </script>
</body>
</html>